{"title":"Compute SPEI","markdown":{"yaml":{"title":"Compute SPEI","author":"JMR","format":"html","editor":"source","editor_options":{"chunk_output_type":"console"}},"headingText":"Introduction","containsRefs":false,"markdown":"\n\n\n\nWhat is SPEI? \nHow does SPEI work?\nHow to interpret SPEI?\n\n## Steps\n\n1. Read the data and georeference the surveys\n2. Crop the global weather data to the survey location\n3. Extract the weather observations based on the survey locations\n4. Create the water balance (precipitation minus potential evapotranspiration) time series for each location\n5. Calculate the SPEI\n6. Merge with survey\n7. Summarize the weather extreme events into indicators based on the date of interview\n8. Write the result\n\n## Code\n### Set Up\n```{r paths}\n#| label: paths\n\npath_to_survey <- file.path(#\"..\",\n                            \"data\", \"survey\", \"LSMS_labor_survey\",\n                            \"labour_forYR_coordinates_new.dta\")\n\npath_to_weather <- file.path(#\"..\",\n                             \"data\", \"weather\", \"ERA5_Land\")\npath_to_pre <- file.path(path_to_weather, \"monthly_pre\",\n                         \"era5_monthly_means_50_21_pre.nc\")\npath_to_pet <- file.path(path_to_weather, \"monthly_pet\",\n                         \"era5_monthly_means_50_21_pet.nc\")\n\npath_to_spei6  <- file.path(#\"..\",\n                           \"data\", \"result\", \"lbr_srv_spei6.dta\")\n```\n\n\n```{r package}\n#| label: package\n\nlibrary(climatic4economist)\n```\n\n### Read\n```{r read_weather}\n#| label: read_weather\n\npre <- terra::rast(path_to_pre)\nnames(pre) <- terra::time(pre)\n\npet <- terra::rast(path_to_pet)\nnames(pet) <- terra::time(pet)\n```\n\n```{r read_survey}\n#| label: read_survey\n\nsurveys <- haven::read_dta(path_to_survey) |>\n  dplyr::filter(survey != \"Uganda16\") |> # 100849\n  dplyr::filter(!is.na(lon_mod) & !is.na(lat_mod)) |>\n  dplyr::select(-dplyr::starts_with(\"UGA\"),\n                -dplyr::starts_with(\"AdmDiv\"),\n                -year) |>\n  dplyr::distinct(survey, hhid, .keep_all = TRUE) |>\n  dplyr::group_by(survey) |>\n  dplyr::group_split() |>\n  lapply(prepare_coord, \n         lon_var = lon_mod,\n         lat_var = lat_mod) |>\n  setNames(c(\"Ethiopia19\", \"Malawi17\", \"Niger14\", \"Nigeria19\", \"Tanzania13\"))\n\nsurvey_geo <- lapply(surveys,\n                     georef_coord,\n                     geom = c(\"lon_mod\", \"lat_mod\"),\n                     crs = \"EPSG:4326\") \n```\n\n### Crop\n```{r crop}\n#| label: crop\n\npre_cntry <- sapply(survey_geo,\n                    terra::crop,\n                    x = pre,\n                    snap = \"out\",\n                    simplify = FALSE)\n\npet_cntry <- sapply(survey_geo,\n                    terra::crop,\n                    x = pet,\n                    snap = \"out\",\n                    simplify = FALSE)\n```\n\n### Extract\n```{r extract}\n#| label: extract\n\npre_coord <- pre_cntry |>\n    purrr::map(terra::focal,\n             w = 3, \n             fun = \"mean\", \n             na.policy = \"only\") |>\n  purrr::map2(survey_geo,\n              extract_by_coord)\n\n\npet_coord <- pet_cntry |>\n  purrr::map(terra::focal,\n             w = 3, \n             fun = \"mean\", \n             na.policy = \"only\") |>\n  purrr::map2(survey_geo,\n              extract_by_coord)\n\n```\n\n### Water Balance\n```{r water_balance}\n#| label: water_balance\n\nwb_coord <- purrr::map2(pre_coord, pet_coord, compute_water_balance)\n\n```\n\n### Compute SPEI\nWe now compute the SPEI with the function `compute_spei()`. This function requires the precipitation time series for each location and the time scale at which the SPEI is computed.\n\nTo compute the SPEI, it is recommended to use at least 30 years of observation to ensure a good estimation of the parameters. More years can strength the estimation but the results can be affected by climate change: if there have been a change in the climate parameters, old observations might be not indicative of the current situation affecting the estimation. There are no clear rule on this, so we leave add the possibility to select the time range of observation with the function `select_by_dates()`. The function requires both or just one between the starting date, `from`, and the end date `to`. If both are provide the the function select between the two dates, if only `from` is provided the function selects all date after, and if only `to` is provided the function selects all date before.\n\nLooking at the result, we see first is the `ID` column, that we will use to merge back with the survey. The other columns contain the SPEI observations over time specific to each coordinate.\n\n```{r compute_spei}\n#| label: compute_spei\n\nspei6 <- purrr::map(wb_coord,\n                    compute_spei,\n                    time_scale = 6)\n\nspei6_date <- purrr::pmap(\n    list(spei6,\n         list(\"2009-01-01\", \"2007-01-01\", \"2004-01-01\", \"2009-01-01\", \"2003-01-01\"),\n         list(\"2019-12-31\", \"2018-01-01\", \"2016-01-01\", \"2019-12-31\", \"2014-01-01\")),\n    select_by_dates)\n\n```\n\n### Merge with survey\nNow, we combine the extracted weather data with the survey data using `ID` as the key matching variable.\n\n```{r merge_survey}\n#| label: merge_survey\n\nspei6_survey <- purrr::map2(surveys, spei6_date, merge_with_survey)\n\n```\n\n### Summarize\nIf we want to select just a subsets of observations we can use the `select_by_dates()` function. If we want to select based on the date of interview of the survey, we can use `select_by_interview()`. This last function requires the variable that contains the dates of interview and the interval to select based on the dates. The interval must be express in number of months or in number years. The `wide` argument specifies how the output should be reported, in wide with each time observation as separate columns, or long, with all observation in one column.\n\n```{r summarize_spei}\n#| label: summarize_spei\n\nspei6_survey_lag0 <- purrr::map(spei6_survey,\n                                select_by_interview,\n                                interview = date_interview,\n                                interval = \"1 month\",\n                                wide = FALSE)\n\n\nl_thrshld <- c(-1, -1.5, -2)\nstd_index6_survy <- purrr::map(spei6_survey_lag0,\n                               extr_std_index,\n                               l_thrshld = l_thrshld)\nstd_index6_survy\n```\n\n### Write\n```{r write}\n#| label: write\n\nstd_index6_survy |>\n  dplyr::bind_rows() |>\n  dplyr::rename_with(.fn = ~ gsub(\"\\\\.|_ind\", \"\", .x)) |>\n  dplyr::rename_with(.fn = ~ gsub(\"std\", \"spei\", .x)) |>\n  haven::write_dta(path_to_spei6)\n\n```\n\n\n## Appendix\n### Data\n#### Weather\nWeather observation are obtained from ERA5-Land reanalysis dataset. H-TESSEL is the land surface model that is the basis of ERA5-Land. The data is a post-processed monthly-mean average of the original ERA5-Land dataset.\n\nIt is possible to find additional information [here](https://cds.climate.copernicus.eu/cdsapp#!/dataset/reanalysis-era5-land-monthly-means?tab=overview) and the related manual [here](https://confluence.ecmwf.int/display/CKB/ERA5-Land). \nThe data can be freely download from [here](https://cds.climate.copernicus.eu/cdsapp#!/dataset/reanalysis-era5-land-monthly-means?tab=overview).\n\n\n| Parameter           | Value                   |\n|:--------------------|:-----------------------:|\n| spatial resolution  | 0.1° x 0.1° lon lat     |\n| temporal resolution | month                   |\n| time frame          | Jan. 1950 - Dec. 2022   |\n| unit of measure     | m                       |\n\n\n##### Total precipitation\nAccumulated liquid and frozen water, including rain and snow, that falls to the Earth's surface. It is the sum of large-scale precipitation and convective precipitation. Precipitation variables do not include fog, dew or the precipitation that evaporates in the atmosphere before it lands at the surface of the Earth.\n\n##### Total evaporation\nAccumulated amount of water that has evaporated from the Earth's surface, including a simplified representation of transpiration (from vegetation), into vapour in the air above. This variable is accumulated from the beginning of the forecast to the end of the forecast step. The ECMWF Integrated Forecasting System convention is that downward fluxes are positive. Therefore, negative values indicate evaporation and positive values indicate condensation.\n\n#### Survey\nThe Living Standards Measurement Study - Integrated Surveys on Agriculture (LSMS-ISA) is a unique system of longitudinal surveys designed to improve the understanding of household and individual welfare, livelihoods and smallholder agriculture in Africa. The LSMS team works with national statistics offices to design and implement household surveys with a strong focus on agriculture.\n\nAdditional information can be find [here](https://www.worldbank.org/en/programs/lsms). The data can be download from [here](https://microdata.worldbank.org/index.php/home).\n\nThe following survey are used in this tutorial.\n\n| Survey    | Year |\n|:----------|-----:|\n| Ethiopia  | 2019 |\n| Malawi    | 2017 |\n| Niger     | 2014 |\n| Nigeria   | 2019 |\n| Tanzania  | 2013 |\n\n\n","srcMarkdownNoYaml":"\n\n\n\n## Introduction\nWhat is SPEI? \nHow does SPEI work?\nHow to interpret SPEI?\n\n## Steps\n\n1. Read the data and georeference the surveys\n2. Crop the global weather data to the survey location\n3. Extract the weather observations based on the survey locations\n4. Create the water balance (precipitation minus potential evapotranspiration) time series for each location\n5. Calculate the SPEI\n6. Merge with survey\n7. Summarize the weather extreme events into indicators based on the date of interview\n8. Write the result\n\n## Code\n### Set Up\n```{r paths}\n#| label: paths\n\npath_to_survey <- file.path(#\"..\",\n                            \"data\", \"survey\", \"LSMS_labor_survey\",\n                            \"labour_forYR_coordinates_new.dta\")\n\npath_to_weather <- file.path(#\"..\",\n                             \"data\", \"weather\", \"ERA5_Land\")\npath_to_pre <- file.path(path_to_weather, \"monthly_pre\",\n                         \"era5_monthly_means_50_21_pre.nc\")\npath_to_pet <- file.path(path_to_weather, \"monthly_pet\",\n                         \"era5_monthly_means_50_21_pet.nc\")\n\npath_to_spei6  <- file.path(#\"..\",\n                           \"data\", \"result\", \"lbr_srv_spei6.dta\")\n```\n\n\n```{r package}\n#| label: package\n\nlibrary(climatic4economist)\n```\n\n### Read\n```{r read_weather}\n#| label: read_weather\n\npre <- terra::rast(path_to_pre)\nnames(pre) <- terra::time(pre)\n\npet <- terra::rast(path_to_pet)\nnames(pet) <- terra::time(pet)\n```\n\n```{r read_survey}\n#| label: read_survey\n\nsurveys <- haven::read_dta(path_to_survey) |>\n  dplyr::filter(survey != \"Uganda16\") |> # 100849\n  dplyr::filter(!is.na(lon_mod) & !is.na(lat_mod)) |>\n  dplyr::select(-dplyr::starts_with(\"UGA\"),\n                -dplyr::starts_with(\"AdmDiv\"),\n                -year) |>\n  dplyr::distinct(survey, hhid, .keep_all = TRUE) |>\n  dplyr::group_by(survey) |>\n  dplyr::group_split() |>\n  lapply(prepare_coord, \n         lon_var = lon_mod,\n         lat_var = lat_mod) |>\n  setNames(c(\"Ethiopia19\", \"Malawi17\", \"Niger14\", \"Nigeria19\", \"Tanzania13\"))\n\nsurvey_geo <- lapply(surveys,\n                     georef_coord,\n                     geom = c(\"lon_mod\", \"lat_mod\"),\n                     crs = \"EPSG:4326\") \n```\n\n### Crop\n```{r crop}\n#| label: crop\n\npre_cntry <- sapply(survey_geo,\n                    terra::crop,\n                    x = pre,\n                    snap = \"out\",\n                    simplify = FALSE)\n\npet_cntry <- sapply(survey_geo,\n                    terra::crop,\n                    x = pet,\n                    snap = \"out\",\n                    simplify = FALSE)\n```\n\n### Extract\n```{r extract}\n#| label: extract\n\npre_coord <- pre_cntry |>\n    purrr::map(terra::focal,\n             w = 3, \n             fun = \"mean\", \n             na.policy = \"only\") |>\n  purrr::map2(survey_geo,\n              extract_by_coord)\n\n\npet_coord <- pet_cntry |>\n  purrr::map(terra::focal,\n             w = 3, \n             fun = \"mean\", \n             na.policy = \"only\") |>\n  purrr::map2(survey_geo,\n              extract_by_coord)\n\n```\n\n### Water Balance\n```{r water_balance}\n#| label: water_balance\n\nwb_coord <- purrr::map2(pre_coord, pet_coord, compute_water_balance)\n\n```\n\n### Compute SPEI\nWe now compute the SPEI with the function `compute_spei()`. This function requires the precipitation time series for each location and the time scale at which the SPEI is computed.\n\nTo compute the SPEI, it is recommended to use at least 30 years of observation to ensure a good estimation of the parameters. More years can strength the estimation but the results can be affected by climate change: if there have been a change in the climate parameters, old observations might be not indicative of the current situation affecting the estimation. There are no clear rule on this, so we leave add the possibility to select the time range of observation with the function `select_by_dates()`. The function requires both or just one between the starting date, `from`, and the end date `to`. If both are provide the the function select between the two dates, if only `from` is provided the function selects all date after, and if only `to` is provided the function selects all date before.\n\nLooking at the result, we see first is the `ID` column, that we will use to merge back with the survey. The other columns contain the SPEI observations over time specific to each coordinate.\n\n```{r compute_spei}\n#| label: compute_spei\n\nspei6 <- purrr::map(wb_coord,\n                    compute_spei,\n                    time_scale = 6)\n\nspei6_date <- purrr::pmap(\n    list(spei6,\n         list(\"2009-01-01\", \"2007-01-01\", \"2004-01-01\", \"2009-01-01\", \"2003-01-01\"),\n         list(\"2019-12-31\", \"2018-01-01\", \"2016-01-01\", \"2019-12-31\", \"2014-01-01\")),\n    select_by_dates)\n\n```\n\n### Merge with survey\nNow, we combine the extracted weather data with the survey data using `ID` as the key matching variable.\n\n```{r merge_survey}\n#| label: merge_survey\n\nspei6_survey <- purrr::map2(surveys, spei6_date, merge_with_survey)\n\n```\n\n### Summarize\nIf we want to select just a subsets of observations we can use the `select_by_dates()` function. If we want to select based on the date of interview of the survey, we can use `select_by_interview()`. This last function requires the variable that contains the dates of interview and the interval to select based on the dates. The interval must be express in number of months or in number years. The `wide` argument specifies how the output should be reported, in wide with each time observation as separate columns, or long, with all observation in one column.\n\n```{r summarize_spei}\n#| label: summarize_spei\n\nspei6_survey_lag0 <- purrr::map(spei6_survey,\n                                select_by_interview,\n                                interview = date_interview,\n                                interval = \"1 month\",\n                                wide = FALSE)\n\n\nl_thrshld <- c(-1, -1.5, -2)\nstd_index6_survy <- purrr::map(spei6_survey_lag0,\n                               extr_std_index,\n                               l_thrshld = l_thrshld)\nstd_index6_survy\n```\n\n### Write\n```{r write}\n#| label: write\n\nstd_index6_survy |>\n  dplyr::bind_rows() |>\n  dplyr::rename_with(.fn = ~ gsub(\"\\\\.|_ind\", \"\", .x)) |>\n  dplyr::rename_with(.fn = ~ gsub(\"std\", \"spei\", .x)) |>\n  haven::write_dta(path_to_spei6)\n\n```\n\n\n## Appendix\n### Data\n#### Weather\nWeather observation are obtained from ERA5-Land reanalysis dataset. H-TESSEL is the land surface model that is the basis of ERA5-Land. The data is a post-processed monthly-mean average of the original ERA5-Land dataset.\n\nIt is possible to find additional information [here](https://cds.climate.copernicus.eu/cdsapp#!/dataset/reanalysis-era5-land-monthly-means?tab=overview) and the related manual [here](https://confluence.ecmwf.int/display/CKB/ERA5-Land). \nThe data can be freely download from [here](https://cds.climate.copernicus.eu/cdsapp#!/dataset/reanalysis-era5-land-monthly-means?tab=overview).\n\n\n| Parameter           | Value                   |\n|:--------------------|:-----------------------:|\n| spatial resolution  | 0.1° x 0.1° lon lat     |\n| temporal resolution | month                   |\n| time frame          | Jan. 1950 - Dec. 2022   |\n| unit of measure     | m                       |\n\n\n##### Total precipitation\nAccumulated liquid and frozen water, including rain and snow, that falls to the Earth's surface. It is the sum of large-scale precipitation and convective precipitation. Precipitation variables do not include fog, dew or the precipitation that evaporates in the atmosphere before it lands at the surface of the Earth.\n\n##### Total evaporation\nAccumulated amount of water that has evaporated from the Earth's surface, including a simplified representation of transpiration (from vegetation), into vapour in the air above. This variable is accumulated from the beginning of the forecast to the end of the forecast step. The ECMWF Integrated Forecasting System convention is that downward fluxes are positive. Therefore, negative values indicate evaporation and positive values indicate condensation.\n\n#### Survey\nThe Living Standards Measurement Study - Integrated Surveys on Agriculture (LSMS-ISA) is a unique system of longitudinal surveys designed to improve the understanding of household and individual welfare, livelihoods and smallholder agriculture in Africa. The LSMS team works with national statistics offices to design and implement household surveys with a strong focus on agriculture.\n\nAdditional information can be find [here](https://www.worldbank.org/en/programs/lsms). The data can be download from [here](https://microdata.worldbank.org/index.php/home).\n\nThe following survey are used in this tutorial.\n\n| Survey    | Year |\n|:----------|-----:|\n| Ethiopia  | 2019 |\n| Malawi    | 2017 |\n| Niger     | 2014 |\n| Nigeria   | 2019 |\n| Tanzania  | 2013 |\n\n\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":false,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":true,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"toc-depth":4,"self-contained":true,"output-file":"lbr_srvy_calculate_spei.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.5.57","author":"JMR","toc-expand":3,"logo":"../images/Climat4Economist_Symbol.png","editor":"source","editor_options":{"chunk_output_type":"console"},"vignette":"%\\VignetteIndexEntry{Vignette's Title} %\\VignetteEncoding{UTF-8} %\\VignetteEngine{quarto::html}\n","toc-location":"right-body","title":"Compute SPEI"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html","docx"]}