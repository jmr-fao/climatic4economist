{"title":"Extract Spatial Control","markdown":{"yaml":{"title":"Extract Spatial Control","author":"JMR","toc":true,"toc-expand":1,"toc-depth":2,"format":{"html":{"self-contained":true,"code-tools":true,"toc-location":"right-body"},"docx":{"toc-location":"body"}},"editor":"source","editor_options":{"chunk_output_type":"console"},"vignette":"%\\VignetteIndexEntry{Vignette's Title} %\\VignetteEncoding{UTF-8} %\\VignetteEngine{quarto::html}\n"},"headingText":"Intro","containsRefs":false,"markdown":"\n\n\nThe goal of this tutorial is to guide the user extract raster data to be use as spatial control in micro economic analysis .\n\n## Overview of Steps\nIn this guide, we will go through the following steps:\n\n1. Load the data\n2. Prepare the survey coordinate\n3. Extract the spatial observations based on the coordinates\n4. Save the result\n\n## Is this guide for me?\n\nThis guide provides a step-by-step approach to extract raster data based on survey locations. The target audience includes economists who may have experience with statistical software (e.g. STATA) but are less familiar with spatial data processing in R.\n\nThe document is not meant to be a course on R or on how the functions work. It is just a practice example on how to extract raster data based on coordinate location. This is done by using specific functions that wrap up as many steps as possible to ensure it is easier for the user to follow.\n\n## What do I need before starting?\n\nThe following R packages are necessary: `terra`, `tidyverse`, `haven`, `data.table`. To install the above package you can use `install.packages(\"name_of_package\")`, don't forget the `\"`. We also need the  package `climate4economist`, which can be installed only locally.\n\nIf you are not familiar with R check the [appendix] for understanding some coding style used in this tutorial.\n\n## Code\n### Set Up\n```{r paths}\n#| label: paths\n\npath_to_sp_control <- file.path(#\"..\",\n                                \"data\", \"spatial\")\npath_to_urca <- file.path(path_to_sp_control, \"URCA\", \"URCA.tif\")\n\npath_to_survey <- file.path(#\"..\",\n                            \"data\", \"survey\", \"LSMS_labor_survey\",\n                            \"labour_forYR_coordinates_new.dta\")\n\npath_to_sp_control <- file.path(\"data\", \"result\", \"lbr_srv_sp_control.dta\")\n```\n\n```{r package}\n#| label: package\n\nlibrary(climatic4economist)\n```\n\n\n### Read\n```{r read_control}\n#| label: read_control\n\nurca <- terra::rast(path_to_urca)\n\n```\n\n```{r read_survey}\n#| label: read_survey\n\nsurveys <- haven::read_dta(path_to_survey) |>\n  dplyr::filter(survey != \"Uganda16\") |> # 100849\n  dplyr::filter(!is.na(lon_mod) & !is.na(lat_mod)) |>\n  dplyr::select(survey, hhid, id_code, lat_mod, lon_mod) |>\n  dplyr::distinct(survey, hhid, .keep_all = TRUE) |>\n  dplyr::group_by(survey) |>\n  dplyr::group_split() |>\n  setNames(c(\"Ethiopia19\", \"Malawi17\", \"Niger14\", \"Nigeria19\", \"Tanzania13\"))\n```\n\n### Prepare the survey coordinates\n```{r geo_ref}\n#| label: geo_ref\n\nsurveys_id <- lapply(surveys,\n                     prepare_coord,\n                     lon_var = lon_mod,\n                     lat_var = lat_mod) \n\nsurvey_geo <- lapply(surveys_id,\n                     georef_coord,\n                     geom = c(\"lon_mod\", \"lat_mod\"),\n                     crs = \"EPSG:4326\") \n```\n\n### Crop\n```{r crop}\n#| label: crop\n\nurca_cntry <- sapply(survey_geo,\n                     terra::crop,\n                     x = urca,\n                     snap = \"out\",\n                     simplify = FALSE)\n```\n\n\n### Extract\n```{r extract}\n#| label: extract\n\nurca_coord <- urca_cntry |>\n  purrr::map(terra::focal,\n             w = 3, \n             fun = \"mean\", \n             na.policy = \"only\") |>\n  purrr::map2(survey_geo,\n              extract_by_coord) |>\n  purrr::map(~dplyr::rename(.x, URCA = focal_mean))\n\n```\n\n### Merge with Survey\n```{r merge_with_survey}\n#| label: merge_with_survey\n\nurca_hh <- purrr::map2(surveys_id,\n                       urca_coord,\n                       merge_with_survey)\n```\n\n### Write\n```{r write}\n#| label: write\n\nurca_hh |>\n  dplyr::bind_rows() |>\n  dplyr::select(-c(lat_mod, lon_mod, x_cell, y_cell)) |>\n  haven::write_dta(path_to_sp_control)\n```\n","srcMarkdownNoYaml":"\n\n\n## Intro\nThe goal of this tutorial is to guide the user extract raster data to be use as spatial control in micro economic analysis .\n\n## Overview of Steps\nIn this guide, we will go through the following steps:\n\n1. Load the data\n2. Prepare the survey coordinate\n3. Extract the spatial observations based on the coordinates\n4. Save the result\n\n## Is this guide for me?\n\nThis guide provides a step-by-step approach to extract raster data based on survey locations. The target audience includes economists who may have experience with statistical software (e.g. STATA) but are less familiar with spatial data processing in R.\n\nThe document is not meant to be a course on R or on how the functions work. It is just a practice example on how to extract raster data based on coordinate location. This is done by using specific functions that wrap up as many steps as possible to ensure it is easier for the user to follow.\n\n## What do I need before starting?\n\nThe following R packages are necessary: `terra`, `tidyverse`, `haven`, `data.table`. To install the above package you can use `install.packages(\"name_of_package\")`, don't forget the `\"`. We also need the  package `climate4economist`, which can be installed only locally.\n\nIf you are not familiar with R check the [appendix] for understanding some coding style used in this tutorial.\n\n## Code\n### Set Up\n```{r paths}\n#| label: paths\n\npath_to_sp_control <- file.path(#\"..\",\n                                \"data\", \"spatial\")\npath_to_urca <- file.path(path_to_sp_control, \"URCA\", \"URCA.tif\")\n\npath_to_survey <- file.path(#\"..\",\n                            \"data\", \"survey\", \"LSMS_labor_survey\",\n                            \"labour_forYR_coordinates_new.dta\")\n\npath_to_sp_control <- file.path(\"data\", \"result\", \"lbr_srv_sp_control.dta\")\n```\n\n```{r package}\n#| label: package\n\nlibrary(climatic4economist)\n```\n\n\n### Read\n```{r read_control}\n#| label: read_control\n\nurca <- terra::rast(path_to_urca)\n\n```\n\n```{r read_survey}\n#| label: read_survey\n\nsurveys <- haven::read_dta(path_to_survey) |>\n  dplyr::filter(survey != \"Uganda16\") |> # 100849\n  dplyr::filter(!is.na(lon_mod) & !is.na(lat_mod)) |>\n  dplyr::select(survey, hhid, id_code, lat_mod, lon_mod) |>\n  dplyr::distinct(survey, hhid, .keep_all = TRUE) |>\n  dplyr::group_by(survey) |>\n  dplyr::group_split() |>\n  setNames(c(\"Ethiopia19\", \"Malawi17\", \"Niger14\", \"Nigeria19\", \"Tanzania13\"))\n```\n\n### Prepare the survey coordinates\n```{r geo_ref}\n#| label: geo_ref\n\nsurveys_id <- lapply(surveys,\n                     prepare_coord,\n                     lon_var = lon_mod,\n                     lat_var = lat_mod) \n\nsurvey_geo <- lapply(surveys_id,\n                     georef_coord,\n                     geom = c(\"lon_mod\", \"lat_mod\"),\n                     crs = \"EPSG:4326\") \n```\n\n### Crop\n```{r crop}\n#| label: crop\n\nurca_cntry <- sapply(survey_geo,\n                     terra::crop,\n                     x = urca,\n                     snap = \"out\",\n                     simplify = FALSE)\n```\n\n\n### Extract\n```{r extract}\n#| label: extract\n\nurca_coord <- urca_cntry |>\n  purrr::map(terra::focal,\n             w = 3, \n             fun = \"mean\", \n             na.policy = \"only\") |>\n  purrr::map2(survey_geo,\n              extract_by_coord) |>\n  purrr::map(~dplyr::rename(.x, URCA = focal_mean))\n\n```\n\n### Merge with Survey\n```{r merge_with_survey}\n#| label: merge_with_survey\n\nurca_hh <- purrr::map2(surveys_id,\n                       urca_coord,\n                       merge_with_survey)\n```\n\n### Write\n```{r write}\n#| label: write\n\nurca_hh |>\n  dplyr::bind_rows() |>\n  dplyr::select(-c(lat_mod, lon_mod, x_cell, y_cell)) |>\n  haven::write_dta(path_to_sp_control)\n```\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":false,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":true,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"toc-depth":2,"self-contained":true,"output-file":"lbr_srvy_sp_control.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.5.57","author":"JMR","toc-expand":1,"logo":"../images/Climat4Economist_Symbol.png","editor":"source","editor_options":{"chunk_output_type":"console"},"vignette":"%\\VignetteIndexEntry{Vignette's Title} %\\VignetteEncoding{UTF-8} %\\VignetteEngine{quarto::html}\n","toc-location":"right-body","title":"Extract Spatial Control"},"extensions":{"book":{"multiFile":true}}},"docx":{"identifier":{"display-name":"MS Word","target-format":"docx","base-format":"docx"},"execute":{"fig-width":5,"fig-height":4,"fig-format":"png","fig-dpi":96,"df-print":"default","error":false,"eval":false,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"docx","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":true,"merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"page-width":6.5},"pandoc":{"default-image-extension":"png","to":"docx","toc":true,"toc-depth":2,"output-file":"lbr_srvy_sp_control.docx"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"author":"JMR","toc-expand":1,"logo":"../images/Climat4Economist_Symbol.png","editor":"source","editor_options":{"chunk_output_type":"console"},"vignette":"%\\VignetteIndexEntry{Vignette's Title} %\\VignetteEncoding{UTF-8} %\\VignetteEngine{quarto::html}\n","toc-location":"body","title":"Extract Spatial Control"},"extensions":{"book":{"selfContainedOutput":true}}}},"projectFormats":["html","docx"]}